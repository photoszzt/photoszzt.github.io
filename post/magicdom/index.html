<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="theme-color" content="#263238">

<meta name="generator" content="Hugo 0.26" />

<link rel="apple-touch-icon" href="photoszzt.github.io/images/logo.png">


<link rel="canonical" href="photoszzt.github.io/post/magicdom/">

    
    <link href="//fonts.googleapis.com/css?family=Roboto+Slab:400,700" rel="stylesheet">
    
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <title>Magicdom - Zhiting Zhu&#39;s Note</title>
    

<meta name="description" content="Motication DOM is the API that allows Javascript to interact with HTML documents. The object that is a part of the DOM API are usually implemented as heap allocated C&#43;&#43;/Rust object for most browsers. For Javascript to interact with these objects, it needs to go through a wrapper called a reflector that gives Javascript code access to the DOM object. For example, the DOM objects and reflectors on Servo is shown on Figure 1.">

<meta property="og:title" content="Magicdom - Zhiting Zhu&#39;s Note">
<meta property="og:type" content="article">
<meta property="og:url" content="photoszzt.github.io/post/magicdom/">
<meta property="og:image" content="photoszzt.github.io/images/default.png">
<meta property="og:site_name" content="Zhiting Zhu&#39;s Note">
<meta property="og:description" content="Motication DOM is the API that allows Javascript to interact with HTML documents. The object that is a part of the DOM API are usually implemented as heap allocated C&#43;&#43;/Rust object for most browsers. For Javascript to interact with these objects, it needs to go through a wrapper called a reflector that gives Javascript code access to the DOM object. For example, the DOM objects and reflectors on Servo is shown on Figure 1.">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="Zhiting Zhu&#39;s Note">
<meta name="twitter:url" content="photoszzt.github.io/post/magicdom/">
<meta name="twitter:title" content="Magicdom - Zhiting Zhu&#39;s Note">
<meta name="twitter:description" content="Motication DOM is the API that allows Javascript to interact with HTML documents. The object that is a part of the DOM API are usually implemented as heap allocated C&#43;&#43;/Rust object for most browsers. For Javascript to interact with these objects, it needs to go through a wrapper called a reflector that gives Javascript code access to the DOM object. For example, the DOM objects and reflectors on Servo is shown on Figure 1.">
<meta name="twitter:image" content="photoszzt.github.io/images/default.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"photoszzt.github.io/"
    },
    "headline": "Magicdom - Zhiting Zhu&#39;s Note",
    "image": {
      "@type": "ImageObject",
      "url": "photoszzt.github.io/images/default.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2017-08-08T16:39:58JST",
    "dateModified": "2017-08-08T16:39:58JST",
    "author": {
      "@type": "Person",
      "name": "Zhiting Zhu&#39;s Note"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Zhiting Zhu&#39;s Note",
      "logo": {
        "@type": "ImageObject",
        "url": "photoszzt.github.io/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "Motication DOM is the API that allows Javascript to interact with HTML documents. The object that is a part of the DOM API are usually implemented as heap allocated C++/Rust object for most browsers. For Javascript to interact with these objects, it needs to go through a wrapper called a reflector that gives Javascript code access to the DOM object. For example, the DOM objects and reflectors on Servo is shown on Figure 1."
  }
</script>


    <style>
      html { font-size: 18px; background-color: rgba(236,239,241,.5);}@media (max-width: 768px) { html { font-size: 15px; }}body { color: #333; font-family: 'Roboto Slab','ヒラギノ角ゴ Pro W3','Hiragino Kaku Gothic Pro',メイリオ,Meiryo,sans-serif; font-feature-settings : "palt"; font-size: inherit; line-height: 1rem; margin: 0; padding: 0;}h1, h2, h3, h4, h5 ,h6 { font-size: 1rem; font-weight: 700; line-height: 1rem; margin: 0;}hr { border: 0; border-top: 1px dashed #cfd8dc; margin: 1rem 0;}p { margin: 0; line-height: 1rem;}a { color: #2196f3; text-decoration: none; transition-duration: .3s;}ul, ol { margin: 0; padding: 0;}table { border-collapse: collapse;}th, td { font-size: .8rem; padding: .5rem;}tr { border-bottom: 1px dashed #ddd;}/* Layouts */main,aside { display: block;}main { padding: 1rem 0 3rem 0; }aside.h { padding: 3rem 0; }main.f,aside.f { background-color: #333; border-top: 2px dashed #fff; border-bottom: 2px dashed #fff;}.l-container { position: relative; max-width: 68rem; margin: 0 auto; padding: 0 1rem;}.l-container.thin { max-width: 44rem;}.l-header { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); padding: 1rem 0; text-align: center;}.l-footer { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); font-size: .6rem; font-weight: 700; padding: 1rem 0;}@media (max-width: 768px) { .l-sidebar { margin-top: 4rem; }}.mrow { margin: 0 -1rem; overflow: hidden;}.mcol { box-sizing: border-box; float: left; padding: 0 1rem;}.c6 { width: 50%; }.c4 { width: 33.26323833%; }.c8 { width: 66.66666%; }@media (max-width: 768px) { .mcol { width: 100%; float: none; }}.logo a { font-size: 1.4rem; line-height: 1.5rem; font-weight: 700; color: #333;}.articles { margin: -1rem 0; margin-bottom: 1rem;}.articles.sm { margin: -.5rem 0; margin-bottom: 0;}article { border-radius: 4px; overflow: hidden;}article.li { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); height: 20rem; overflow: hidden; margin: 1rem 0;}article.li > a { display: block; color: #333;}article.li .inner { padding: 1rem;}article.li .thumb { height: 8rem;}article.li .title { color: #333; font-size: 1.2rem; line-height: 1.5rem; margin-bottom: .5rem;}article.li .summary { font-size: .8rem; height: 6rem; overflow: hidden; margin-top: 1rem;}article.lism { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); margin: .5rem 0;}article.lism::after { content: ''; display: block; clear: both;}article.lism > a { display: block; color: #333;}article.lism .inner { display: table-cell; vertical-align: middle; height: 5rem; padding-left: .5rem;}article.lism .thumb { width: 5rem; height: 5rem; float: left;}article.lism .title { font-weight: 700; line-height: 1.25rem; margin-bottom: .25rem;}article.sn { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); margin-bottom: 1rem;}article.sn .thumb { height: 20rem;}@media (max-width: 768px) { article.sn .thumb { height: 10rem; }}article.sn > .article-header,article.sn > .article-body,article.sn .article-footer { padding: 2rem;}article.sn > .article-body { padding: 0 2rem;}@media (max-width: 768px) { article.sn > .article-header, article.sn > .article-body, article.sn .article-footer { padding: 1rem; } article.sn > .article-body { padding: 0 1rem; }}article.sn > .article-header .title { font-size: 1.8rem; line-height: 2rem; margin-bottom: .5rem;}@media (max-width: 768px) { article.sn > .article-header .title { font-size: 1.4rem; line-height: 1.5rem; }}article.sn > .article-header .facts { margin-bottom: 1rem;}article.sn > .article-body { margin-bottom: 1.5rem;}article.sn > .article-body h2 { border-bottom: .25rem solid #333; font-size: 1.2rem; line-height: 1.5rem; margin: 1.5rem 0; padding: .5rem 0;}article.sn > .article-body h3 { border-left: .5rem solid #333; line-height: 1.5rem; margin: 1.5rem 0; padding: .125rem .5rem;}article.sn > .article-body ul,article.sn > .article-body ol { margin: 1.5rem 0; padding-left: 1.5rem;}article.sn > .article-body li { padding-bottom: .5rem; line-height: 1.5rem;}article.sn > .article-body li:last-child { padding-bottom: 0;}article.sn > .article-body p { margin: 1rem 0; line-height: 1.5rem;}article.sn > .article-body strong,article.sn > .article-body em { font-style: normal; font-weight: 700;}article.sn > .article-body strong { box-shadow: 0 -.5rem 0 0 #ffc107 inset;}article.sn > .article-body em { color: #8bc34a;}article.sn > .article-body code,article.sn > .article-body pre { font-family: Menlo, Consolas, monospace; font-size: .7rem;}article.sn > .article-body pre { background-color: #333; color: #fff; line-height: 1rem; margin: 1.5rem -2rem; overflow: auto;}@media (max-width: 768px) { article.sn > .article-body pre { margin: 1.5rem -1rem; }}article.sn > .article-body pre > code { display: block; padding: 1rem 2rem;}@media (max-width: 768px) { article.sn > .article-body pre > code { padding: 1rem; }}article.sn > .article-body p code { background-color: #eceff1; color: #333; border-radius: 4px; margin: 0 .25rem; padding: .375rem; white-space: nowrap;}article.sn > .article-body blockquote { position: relative; border-left: .25rem solid #333; font-size: .8rem; padding: .125rem 1rem; margin: 1.5rem 0;}@media (max-width: 768px) { article.sn > .article-body blockquote { font-size: 1rem; }}article.sn > .article-body blockquote p { margin: .5rem 0; line-height: 1rem;}article.sn > .article-body figure { margin: 1.5rem 0;}article.sn > .article-body figure img,article.sn > .article-body figure amp-img { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); max-width: 100%;}article.sn > .article-body figcaption { color: #cfd8dc; font-size: .8rem; font-weight: 700; margin-top: .5rem;}.facts li { display: inline; font-size: .8rem; margin-right: 1rem;}.facts i { color: #cfd8dc; margin-right: .5em;}.facts.sm li { font-size: .7rem;}.sections.sidebar { margin: -1rem 0;}.sections.footer { margin: -1rem 0;}section.sidebar { margin: 2rem 0;}section.sidebar > header { font-size: .8rem; font-weight: 700; letter-spacing: 4px; text-align: center; margin: 1.5rem 0;}section.footer { margin: 1rem 0;}section.footer > header { font-size: .8rem; margin: .5rem 0;}section.footer > header::before { content: "- ";}section.footer > header a { font-weight: 700; color: #333; text-decoration: underline;}.terms { margin: -.25rem;}.terms li { display: inline-block;}.terms a { display: block; float: left; background-color: #333; border-radius: 4px; color: #fff; font-size: .7rem; margin: .25rem; padding: 0 .75rem; line-height: 1.75rem;}.paging { text-align: center; padding: 1rem 0;}.paging a { display: inline-block; background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); border-radius: 4px; color: #333; padding: 0 1rem; line-height: 3rem;}.page-title { text-align: center; margin: 1rem 0;}.page-title::after { content: ''; display: block; border-bottom: .25rem solid #333; width: 3rem; margin: 1.5rem auto;}.page-title > .title { font-size: 1.2rem; line-height: 1.5rem;}/* Parts:breadcrumb */.crumb ol { text-overflow: ellipsis; color: #cfd8dc; white-space: nowrap; overflow: hidden;}.crumb li { display: inline; font-size: .8rem;}.crumb li::after { content: '›'; margin: 0 .25rem 0 .5rem;}.crumb li:last-child::after { content: '';}.crumb a { color: #cfd8dc;}.crumb i { margin-right: .5em;}.share { padding: 0;}.share a { display: inline-block; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); min-width: 1rem; height: 2rem; border-radius: 4px; color: #333; font-size: .8rem; font-weight: 700; line-height: 2rem; text-align: center; padding: 0 .5rem;}.adj article.lism { margin-bottom: 1rem;}.adj header { font-weight: 700; font-size: .8rem;}.toc { padding: 0 2rem;}@media (max-width: 768px) { .toc { padding: 0 1rem; }}.toc { margin: 1rem 0;}.toc nav>ul { background-color: #eceff1; border-radius: 4px; display: inline-block; font-size: .8rem; padding: .5rem 1rem; word-break: break-all; list-style: none;}.toc ul { padding: 0;}.toc ul ul { padding-left: 1rem;}.toc ul ul ul { padding-left: 1rem;}.toc li { color: #90a4ae;}.toc ul ul>li { font-weight: 700; margin: .5rem 0; list-style-type: decimal;}.toc ul ul ul>li { list-style-type: disc; font-weight: 500;}.thumb { background-image: url(photoszzt.github.io/images/default.jpg); background-size: cover;}
      
      
    </style>
  </head>

  <body>
    
    
    

    <header class="l-header">
      <div class="l-container">
        <div class="logo">
          <a href="photoszzt.github.io/">Zhiting Zhu&#39;s Note</a>
        </div>
      </div>
    </header>

    <main>
      <div class="l-container">
        
<div class="mrow">
  <div class="mcol c8">

    <article class="sn">

  <div class="thumb thumb-9f9d7963b6dab949c7c80c77c8035213"></div>

  <header class="article-header">
    <h1 class="title">Magicdom</h1>

    <ul class="facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2017-08-08T16:39:58JST">Aug 8, 2017</time></li>
      <li><i class="fa fa-bookmark" aria-hidden="true"></i><a href="photoszzt.github.io/post/">POST</a></li>
      
    </ul>

    <aside class="share">
  <a href="http://b.hatena.ne.jp/add?mode=confirm&url=photoszzt.github.io%2fpost%2fmagicdom%2f&title=Magicdom" title="はてなブックマーク" class="ht" target="_blank" rel="nofollow">B!</a>
  <a href="http://twitter.com/intent/tweet?url=photoszzt.github.io%2fpost%2fmagicdom%2f&text=Magicdom&tw_p=tweetbutton" title="Twitterでシェア" class="tw" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  <a href="http://www.facebook.com/sharer.php?u=photoszzt.github.io%2fpost%2fmagicdom%2f&t=Magicdom" title="Facebookでシェア" class="fb" target="_blank" rel="nofollow"><i class="fa fa-facebook" aria-hidden="true"></i></a>
  <a href="https://plus.google.com/share?url=photoszzt.github.io%2fpost%2fmagicdom%2f" title="Google Plusでシェア" class="gp" target="_blank" rel="nofollow"><i class="fa fa-google-plus" aria-hidden="true"></i></a>
  <a href="http://getpocket.com/edit?url=photoszzt.github.io%2fpost%2fmagicdom%2f&title=Magicdom" title="Pocketに保存" class="pk" target="_blank" rel="nofollow"><i class="fa fa-get-pocket" aria-hidden="true"></i></a>
  <a href="http://line.me/R/msg/text/?Magicdom photoszzt.github.io%2fpost%2fmagicdom%2f" title="LINEでシェア" class="ln" target="_blank" rel="nofollow">LINE</a>
</aside>

  </header>

  

  <div class="article-body">

<h2 id="motication">Motication</h2>

<p>DOM is the API that allows Javascript to interact with HTML documents.
The object that is a part of the DOM API are usually implemented as
heap allocated C++/Rust object for most browsers. For Javascript to
interact with these objects, it needs to go through a wrapper called
a reflector that gives Javascript code access to the DOM object. For example,
the DOM objects and reflectors on Servo is shown on Figure 1.

<figure >
    
        <img src="/img/magicdom/reflector.png" alt="Figure 1. DOM Object and Reflector" />
    
    
    <figcaption>
        <p>
        Figure 1. DOM Object and Reflector
        
            
        
        </p> 
    </figcaption>
    
</figure>

The reflector is a JSObject managed by SpiderMonkey. There&rsquo;s a pointer stored
in one of the inline slots which points back to the heap allocated DOM object.</p>

<p>There are a couple downside for this implementation, but the biggest
problem is performance:</p>

<ul>
<li><strong>Type conversion</strong> For most browsers that imploy this design, the API are
implemented in native code. Since native code and Javascript use different types,
expensive conversions have to perform to convert Javascript values into
equivalent native types. For function return, native types then need to be
converted to JS values. One extreme example is converting Rust Vec to/from
Javascript Array. Each conversion requires a deep copy of the data structure
which is very costly.</li>
<li><strong>JIT Optimization</strong> Native function is opaque to Javascript JIT, which makes it
difficult to do optimizations specific to the calling code.</li>
</ul>

<p>These problems can be mitigated to some degree. Conversions can be made cheaper.
Hints can be given to the JIT to perform some limited optimization, for example
the pure annotation on WebIDL for the DOM accessers.</p>

<h2 id="magicdom">MagicDOM</h2>

<p>Based on the observation, instead of storing the fields of DOM in a separate
heap allocated object, MagicDOM stores all of the fields in the reflector (Figure 2).

<figure >
    
        <img src="/img/magicdom/transform.png" alt="Figure 2. MagicDOM" />
    
    
    <figcaption>
        <p>
        Figure 2. MagicDOM
        
            
        
        </p> 
    </figcaption>
    
</figure>
</p>

<p>From Figure 2, all of the fields are stored in the reserved slots in the JSObject.
There are 16 inline slots which stores at the struct of JSObject<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>. If more slots
are needed, data will be stored in dynamic slots. In total, at most 255 slots.
can be used.</p>

<p>Data stores in the slots would be in <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/JSAPI_Reference/JS::Value">JSValues</a>
rather than native types provide opportunites for optimizations. But native code
needs to convert JSValues back to native types when working with DOM objects.
This is offset by the following:</p>

<ul>
<li><strong>Conversions</strong> JSValues to/from native types conversions are highly optimized.
The JSValues that are stored in slots are well defined which doesn&rsquo;t need to
account for the edge cases. It&rsquo;s very fast compared to the JSValues got from
arbitrary scripts.</li>
<li><strong>DOM API</strong> DOM interfaces can be implemented partially or entirely in Javascript
which avoids the cost of conversions and allows JIT optimizations which is
limited with native DOM interfaces.</li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>MagicDOM utilizes many Rust features to reduce the engineering efforts and makes
the implementation easy to adapt to use cases other than DOM. The code is open
source at <a href="https://github.com/fitzgen/mozjs/tree/magic-dom">https://github.com/fitzgen/mozjs/tree/magic-dom</a></p>

<h3 id="mix-native-and-javascript-data-types">Mix native and Javascript data types</h3>

<p>MagicDOM allows fields to have use either Rust type or Javascript side type as
shown in the code snippet below. Node has both Rust type fields like u16 and
Vec<Node> and Javascript side type fields like JSString. To
help the conversion between Rust and Javascript type, two traits are implemented.</p>

<ul>
<li><strong>ToFromJSConvertible</strong> This trait defines methods that converts the Rust type
to/from Javascript type. Most of the Rust primitive types have implemented it.
Rust Vec also implements this trait to convert to
the corresponding Javascript type, JSArray and it&rsquo;s doing a deep copy for
conversion.</li>

<li><p><strong>ToFromJSSlots</strong> This trait defines methods that stores data into and retrieve
data back from the slot. All of the primitive type in Rust implements this
trait. Unlike the above trait, the fat pointer of Vec (raw pointer, length and
capacity) is stored in three separate slots which avoids deep copy.</p>

<pre><code class="language-Rust">struct Node_struct {
    node_type: u16,
    node_name: *mut JSString,
    base_uri: *mut JSString,
    is_connected: bool,
    node_value: *mut JSString,
    text_content: *mut JSString,
    child_nodes: Vec&lt;Node&gt;,
}
</code></pre>

<h3 id="inheritance">Inheritance</h3>

<p>To implement inheritance, MagicDOM embeds all the slots from parent class into the
current class. Below is an example of a class that has inheritance. The parent
class inheritance has to be embed in the first field of the current class. All
the slots that belongs to the current class comes after the parent class slots.</p>

<pre><code class="language-Rust">struct Element_spec {
    _inherit: node::Node,
    local_name: *mut JSString,
    tag_name: *mut JSString,
    namespace: *mut JSString,
    prefix: *mut JSString,
    id: *mut JSString,
    attrs: Vec&lt;attr::Attr&gt;,
};
</code></pre>

<h3 id="code-generation-using-procedure-macro-and-macro-rules">Code Generation using procedure macro and macro rules</h3>

<p>For the DOM accessers, it needs to know where the fields are stored in the slots.
Not all fields occupy the same number of slots. With object inheritance, developer
needs to keep track of the number of slots to shift. It&rsquo;s very tedious for human
to write all the accessers and most of these methods have similar structores.</p></li>
</ul>

<p>MagicDOM uses Rust&rsquo;s <a href="https://github.com/rust-lang/rfcs/blob/master/text/1566-proc-macros.md">procedure macro</a>
and macro rules to solve this problem. Given a spec like the following code snippet,</p>

<pre><code class="language-Rust">#[derive(MagicDOM)]
struct Element_spec {
    _inherit: node::Node,
    local_name: *mut JSString,
    tag_name: *mut JSString,
    namespace: *mut JSString,
    prefix: *mut JSString,
    id: *mut JSString,
    attrs: Vec&lt;attr::Attr&gt;,
};
</code></pre>

<p>the #[derive(MagicDOM)] transform the above code into the following code snippet.</p>

<pre><code class="language-Rust">pub struct Element {
    object: *mut JSObject,
}
</code></pre>

<p>and generates the following implementations:
- Getter (Rust and self hosted Javascript)
- Setter (Rust and self hosted Javascript)
- Constructor (Rust)
- Trait implementations that stores and retrieve MagicDOM from slots</p>

<p>Slot number is calculated when generating the getter and setter. To help to
calculate the slot number in face of inheritance, all types including
MagicDOM implements a Trait, NumSlots, that returns the number of slots occupy by this type.
The MagicDOM implementation of this trait is also auto generated. There are
also other helper methods and trait implementation generated to aid code generation
or better operate with SpiderMonkey GC. More details are available in the <a href="https://github.com/fitzgen/mozjs/blob/magic-dom/mozjs/js/rust/magic_codegen/src/lib.rs">source
code</a>.</p>

<h2 id="evaluation">Evaluation</h2>

<p>To evaluate the performance of MagicDOM, a few <a href="http://dromaeo.com/?dom">Dromeao</a>
DOM Core tests are ported as MagicDOM currently doesn&rsquo;t implement all of the
DOM API and not intergrated with any browser yet. MagicDOM is evaluated with
three implementation.</p>

<ul>
<li><strong>Selfhosted</strong>: Self hosted JavaScript storing JavaScript values</li>
<li><strong>JS native</strong>: Rust native code storing JavaScript values</li>
<li><strong>Rust</strong>: Rust native code storing Rust values</li>
</ul>

<p>Not all tests have all three implementations and some test has more test cases
that will be described in the corresponding section.</p>

<h3 id="getid">GetId</h3>

<p>This method is tested by calling 102400 times in a loop and measure the total
time. The normal js test case is the following:</p>

<pre><code class="language-js">    var a = {id: &quot;jaz&quot;};
    for ( var i = 0; i &lt; num; i++) {
        ret = a.id;
    }
</code></pre>

<p>The normal js is not equivalent to the selfhosted JavaScript but it&rsquo;s a lower
bound to see how well the JIT can optimize the code.

<figure >
    
        <img src="/img/magicdom/getid.png" alt="Figure 3. GetId" />
    
    
    <figcaption>
        <p>
        Figure 3. GetId
        
            
        
        </p> 
    </figcaption>
    
</figure>

From Figure 3, we can see that the self hosted Javascript is done better than
the js native. Here the id is stored as JSString.</p>

<h3 id="setid">SetId</h3>

<p>This method is tested by calling 102400 times in a loop and measure the total
time. The normal js test case is the following:</p>

<pre><code class="language-js">    var a = {id: &quot;jaz&quot;};
    for ( var i = 0; i &lt; num; i++) {
        a.id = &quot;caz&quot;;
    }
</code></pre>

<p>
<figure >
    
        <img src="/img/magicdom/setid.png" alt="Figure 4. SetId" />
    
    
    <figcaption>
        <p>
        Figure 4. SetId
        
            
        
        </p> 
    </figcaption>
    
</figure>

From Figure 4, SetId is also doing better. After showing benefits for simple
methods, let&rsquo;s look at some complex methods.</p>

<h3 id="getattributes">GetAttributes</h3>

<p>This method is tested by calling 102400 times in a loop and measure the total
time.

<figure >
    
        <img src="/img/magicdom/getattributes.png" alt="Figure 5. GetAttributes" />
    
    
    <figcaption>
        <p>
        Figure 5. GetAttributes
        
            
        
        </p> 
    </figcaption>
    
</figure>

Selfhosted method performs pretty poor. In this method, the attr
array is implemented using Vec for Rust type and JSArrayObject for Javascript type.
For this method, the cost of VM call from the Javascript side to native side is
amortized by the fast native implementation.</p>

<h3 id="setattributes">SetAttributes</h3>

<p>This method is tested by calling 102400 times in a loop and measure the total
time. Selfhosted JavaScript implementation is not available for this test. SetAttributes
needs to create a new Attr when there&rsquo;s no attr matched with the name. There&rsquo;s no
way in SpiderMonkey now to support this. But there are <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1226551">two</a>
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1226261">patches</a> in review trying
to address this problem.

<figure >
    
        <img src="/img/magicdom/setattributes.png" alt="Figure 6. SetAttributes" />
    
    
    <figcaption>
        <p>
        Figure 6. SetAttributes
        
            
        
        </p> 
    </figcaption>
    
</figure>
</p>

<h3 id="appendchilds">AppendChilds</h3>

<p>This method is tested by appending 2000 elements on a node in one trial,
running 1024 trials in a loop and measuring the total time.

<figure >
    
        <img src="/img/magicdom/appendchild.png" alt="Figure 7. AppendChilds" />
    
    
    <figcaption>
        <p>
        Figure 7. AppendChilds
        
            
        
        </p> 
    </figcaption>
    
</figure>
</p>

<h2 id="discussion">Discussion</h2>

<p>Based on the above experiments, we can see that MagicDOM shows benefits for simple
get/set methods. We still need more investigation on JIT to speedup the selfhosted
Javascript. For the complex method, selfhosted Javascript doesn&rsquo;t show too much
edge there. But this may due to my infamiliar with the JIT and Javascript features
and I think it could be improved.</p>

<p>This framework could be also used to define general data structure to use in the
non browser use cases.</p>

<p>Using selfhosted JavaScript code is not easy. Those code needs to compile with
the SpiderMonkey and the generated Javascript code also needs to manually copy
and paste in to the Utilities.js. The flow of generating Javascript code could
also be improved. Currently all the generated Javascript code are in one line
and before putting those in SpiderMonkey, a sed script needs to run to separate
the lines.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">We cannot add more inline slots right now as it&rsquo;s limited by the <a href="http://searchfox.org/mozilla-central/source/mfbt/EnumSet.h#27">EnumSet</a> which only allows 32 bits and AllocKind already using all of the bits.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
</div>

  <footer class="article-footer">

    <aside class="share">
  <a href="http://b.hatena.ne.jp/add?mode=confirm&url=photoszzt.github.io%2fpost%2fmagicdom%2f&title=Magicdom" title="はてなブックマーク" class="ht" target="_blank" rel="nofollow">B!</a>
  <a href="http://twitter.com/intent/tweet?url=photoszzt.github.io%2fpost%2fmagicdom%2f&text=Magicdom&tw_p=tweetbutton" title="Twitterでシェア" class="tw" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a>
  <a href="http://www.facebook.com/sharer.php?u=photoszzt.github.io%2fpost%2fmagicdom%2f&t=Magicdom" title="Facebookでシェア" class="fb" target="_blank" rel="nofollow"><i class="fa fa-facebook" aria-hidden="true"></i></a>
  <a href="https://plus.google.com/share?url=photoszzt.github.io%2fpost%2fmagicdom%2f" title="Google Plusでシェア" class="gp" target="_blank" rel="nofollow"><i class="fa fa-google-plus" aria-hidden="true"></i></a>
  <a href="http://getpocket.com/edit?url=photoszzt.github.io%2fpost%2fmagicdom%2f&title=Magicdom" title="Pocketに保存" class="pk" target="_blank" rel="nofollow"><i class="fa fa-get-pocket" aria-hidden="true"></i></a>
  <a href="http://line.me/R/msg/text/?Magicdom photoszzt.github.io%2fpost%2fmagicdom%2f" title="LINEでシェア" class="ln" target="_blank" rel="nofollow">LINE</a>
</aside>


    <section class="footer">
      <div>
        <nav class="crumb">
          <ol>
            <li><a href="photoszzt.github.io/"><i class="fa fa-home" aria-hidden="true"></i>TOP</a></li>
            
            <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="photoszzt.github.io/post/" itemprop="url"><span itemprop="title">POST</span></a></li>
            
            <li class="active">Magicdom</li>
          </ol>
        </nav>
      </div>
    </section>

    
    
    
    
    
    
  </footer>

</article>


    <div class="adj">
      <div class="mrow">
        
        
      </div>
    </div>

    
  </div>
  <div class="mcol c4">
    <aside class="l-sidebar">

  <div class="sections sidebar">
    <section class="sidebar">
      <header>LATESTS</header>
      <div>
        <div class="articles sm">
          
          <article class="lism">
  <a href="photoszzt.github.io/post/magicdom/">
    <div class="thumb thumb-9f9d7963b6dab949c7c80c77c8035213"></div>

    <div class="inner">
      <div class="title">Magicdom</div>

      <ul class="facts sm">
        <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2017-08-08T16:39:58JST">Aug 8, 2017</time></li>
        <li><i class="fa fa-bookmark" aria-hidden="true"></i>POST</li>
        
      </ul>

    </div>
  </a>
</article>

          
          
          
          
          
          
          
          
          
        </div>
      </div>
    </section>

    
    <section class="sidebar">
      <header>CATEGORIES</header>
      <div>
        <ul class="terms">
          
        </ul>
      </div>
    </section>
    
    <section class="sidebar">
      <header>TAGS</header>
      <div>
        <ul class="terms">
          
        </ul>
      </div>
    </section>
    
  </div>

</aside>

  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="l-container">
        <p><span class="h-logo">&copy; Zhiting Zhu&#39;s Note</span></p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_robust">Robust</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

